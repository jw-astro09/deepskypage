<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEEP SKY - 자료실</title>
    <style>
        body { margin:0; font-family: "Segoe UI", Arial, sans-serif; background:#0b0f2b; color:white; }

        /* 상단 통합 바 */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: #070a1d; border-bottom: 1px solid #1b2f80;
        }

        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; }

        .auth-bar { font-size: 14px; display: flex; align-items: center; }
        .auth-bar button {
            padding: 5px 12px; margin-left: 10px; border-radius: 5px; border: none;
            background: #3a5aff; color: white; cursor: pointer; font-weight: bold;
        }

        header { background: linear-gradient(to right,#0d1b52,#1b2f80); padding:40px 20px; text-align:center; }
        nav { background-color: #11153a; padding: 12px; text-align: center; border-bottom: 1px solid #2d367a; }
        nav a { color: white; margin: 0 15px; text-decoration: none; font-weight: bold; }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        .card { background:#161b4a; padding:20px; border-radius:12px; margin-bottom:20px; border: 1px solid #2d367a; }
        
        input { 
            padding:12px; margin:5px 0; border-radius: 5px; border: 1px solid #1b2f80; 
            background: #0b0f2b; color: white; width: 100%; box-sizing: border-box; 
        }

        .btn-main { background: #3a5aff; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        
        .resource-list { width: 100%; border-collapse: collapse; }
        .resource-list th, .resource-list td { padding: 15px; text-align: left; border-bottom: 1px solid #2d367a; }
        .resource-list th { background: #0d1b52; color: #7fc7ff; font-size: 14px; }
        
        .download-link { background: #28a745; color: white; padding: 6px 12px; text-decoration: none; border-radius: 5px; font-size: 13px; }
        .delete-btn { background: #ff4d4d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        
        .hidden { display: none; }
        footer { position: fixed; bottom: 0; width: 100%; background: #070a1d; text-align: center; padding: 15px; color: #888; font-size: 12px; border-top: 1px solid #1b2f80; }

        /* --- 반응형 스타일 (모바일 기기) --- */
@media (max-width: 768px) {
    .logo-area span { font-size: 15px; }
    nav a { margin: 0 8px; font-size: 13px; }
    
    /* 기존에 td:nth-child(2)를 숨기던 코드를 삭제하여 이름이 보이게 함 */
    .resource-list th, .resource-list td { padding: 10px 8px; font-size: 12px; }
    
    header { padding: 20px; }
    footer { position: relative; margin-top: 20px; }
}
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" alt="로고" onerror="this.src='https://via.placeholder.com/35?text=★'"> 
        <span>DEEP SKY</span>
    </a>
    <div class="auth-bar">
        <span id="userStatus">불러오는 중...</span>
        <button id="loginBtn" onclick="location.href='login.html'">로그인</button>
        <button id="logoutBtn" class="hidden">로그아웃</button>
    </div>
</div>

<header>
    <h1>학습 자료실</h1>
    <p style="opacity: 0.8; font-size: 14px;">여러 자료들을 공유하는 공간입니다.</p>
</header>

<nav>
    <a href="index.html">홈</a>
    <!-- <a href="introduce.html">소개</a> -->
    <a href="question.html">질문</a>
    <a href="activity.html">활동 사진</a>
    <a href="resource.html">자료실</a>
</nav>

<div class="container">
    <div class="card">
        <h3 style="margin-top:0; color: #7fc7ff;">자료 검색</h3>
        <input type="text" id="resSearch" placeholder="자료 제목으로 검색하세요." onkeyup="filterResources()">
    </div>

    <div id="uploadSection" class="card hidden">
        <h3 style="margin-top:0; color: #7fc7ff;">새 자료 등록</h3>
        <input type="text" id="resTitle" placeholder="자료 제목을 입력하세요">
        <input type="text" id="resUrl" placeholder="공유 링크 주소 (Google Drive 등)">
        <button class="btn-main" id="btnSave">자료실에 올리기</button>
    </div>

    <div class="card" style="padding: 10px; overflow-x: auto;">
        <table class="resource-list">
            <thead>
                <tr>
                    <th>제목</th>
                    <th>올린 사람</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody id="resTableBody">
                <tr><td colspan='3' style='text-align:center; padding: 30px;'>자료를 불러오고 있습니다...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<footer>© DEEP SKY(복성고 과학 동아리) | All rights reserved</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBX9JG1Ngnx_Pt02ROG2Hp69rnNbK0Pjp8",
    authDomain: "clubquestion.firebaseapp.com",
    databaseURL: "https://clubquestion-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "clubquestion"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_EMAIL = "2jw5464@gmail.com";

let currentUserInfo = { email: "", name: "" };

auth.onAuthStateChanged(user => {
    const userStatus = document.getElementById("userStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadSection = document.getElementById("uploadSection");

    if (user) {
        currentUserInfo.email = user.email;
        // Firebase Auth의 displayName(이름)을 가져옴, 없으면 이메일 아이디 사용
        currentUserInfo.name = user.displayName || user.email.split('@')[0];
        
        userStatus.innerText = `${currentUserInfo.name}님`;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        uploadSection.classList.remove("hidden");
    } else {
        userStatus.innerText = "비로그인 상태";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        uploadSection.classList.add("hidden");
    }
    loadResources();
});

document.getElementById("btnSave").onclick = async () => {
    const title = document.getElementById("resTitle").value.trim();
    const url = document.getElementById("resUrl").value.trim();
    if(!title || !url) return alert("항목을 모두 입력하세요.");

    try {
        await db.ref('resources').push({
            title: title,
            url: url,
            ownerName: currentUserInfo.name, // 계정 이름 저장
            ownerEmail: currentUserInfo.email,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        alert("등록 성공!");
        document.getElementById("resTitle").value = "";
        document.getElementById("resUrl").value = "";
    } catch(e) { alert("오류 발생"); }
};

function loadResources() {
    const tableBody = document.getElementById("resTableBody");
    db.ref('resources').orderByChild('timestamp').on('value', snapshot => {
        tableBody.innerHTML = "";
        const data = snapshot.val();
        if(!data) {
            tableBody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>등록된 자료가 없습니다.</td></tr>";
            return;
        }

        const items = Object.keys(data).map(key => ({ key, ...data[key] })).reverse();
        items.forEach(item => {
            const row = document.createElement("tr");
            let deleteBtn = "";
            
            if(auth.currentUser && (auth.currentUser.email === ADMIN_EMAIL || auth.currentUser.email === item.ownerEmail)) {
                deleteBtn = `<button class="delete-btn" onclick="deleteRes('${item.key}')">삭제</button>`;
            }

            // 표시할 이름 결정 (이름이 없으면 아이디나 '익명' 표시)
            const displayName = item.ownerName || (item.ownerEmail ? item.ownerEmail.split('@')[0] : "익명");

            row.innerHTML = `
                <td style="font-weight: bold;">${item.title}</td>
                <td style="font-size:12px; color:#7fc7ff;">${displayName}</td>
                <td>
                    <div style="display: flex;">
                        <a href="${item.url}" target="_blank" class="download-link">보기</a>
                        ${deleteBtn}
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    });
}

window.deleteRes = (key) => { if(confirm("삭제하시겠습니까?")) db.ref('resources/' + key).remove(); };
document.getElementById("logoutBtn").onclick = () => auth.signOut();

function filterResources() {
    const searchTerm = document.getElementById("resSearch").value.toLowerCase();
    const rows = document.getElementById("resTableBody").getElementsByTagName("tr");
    for (let row of rows) {
        const titleColumn = row.getElementsByTagName("td")[0];
        if (titleColumn) {
            row.style.display = titleColumn.innerText.toLowerCase().includes(searchTerm) ? "" : "none";
        }
    }
}
</script>
</body>
</html>
