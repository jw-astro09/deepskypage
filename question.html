<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>질문 게시판 - DEEP SKY</title>
    <style>
        /* [이전 스타일과 동일 - 생략 없이 유지] */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: #0b0f2b; color: white; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: #070a1d; border-bottom: 1px solid #1b2f80; height: 60px; position: sticky; top:0; z-index:1000; }
        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; }
        .auth-bar { font-size: 14px; display: flex; align-items: center; }
        .auth-bar button { padding: 5px 12px; margin-left: 10px; border-radius: 5px; border: none; background: #3a5aff; color: white; cursor: pointer; font-weight: bold; }
        header { background: linear-gradient(to right, #0d1b52, #1b2f80); padding: 40px 20px; text-align: center; }
        nav { background: #11153a; padding: 0 10px; text-align: center; border-bottom: 1px solid #2d367a; overflow-x: auto; white-space: nowrap; }
        nav a { display: inline-block; color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; font-size: 15px; }
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px 100px; }
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80; background: #161b4a; color: white; font-size: 15px; }
        .write-card { background: #161b4a; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #2d367a; }
        .write-card input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80; background: #0b0f2b; color: white; margin-bottom: 10px; }
        .btn-main { width: 100%; padding: 12px; background: #3a5aff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .q-card { background: #161b4a; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #2d367a; }
        .q-meta { font-size: 12px; color: #7fc7ff; margin-bottom: 8px; }
        .q-text { font-weight: bold; font-size: 16px; margin-bottom: 10px; display: block; }
        .ans-box { background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #28a745; }
        .answer-controls { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #2d367a; display: flex; gap: 5px; flex-wrap: wrap; }
        .answer-controls input { flex: 1; min-width: 200px; padding: 8px; border-radius: 5px; border: 1px solid #1b2f80; background: #0b0f2b; color: white; }
        .btn-ans { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        footer { background: #070a1d; text-align: center; padding: 20px; font-size: 12px; color: #888; border-top: 1px solid #1b2f80; position: fixed; bottom: 0; width: 100%; }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/35'">
        <span>DEEP SKY</span>
    </a>
    <div class="auth-bar">
        <span id="userStatus">불러오는 중...</span>
        <button id="loginBtn" onclick="location.href='login.html'">로그인</button>
        <button id="logoutBtn" class="hidden" onclick="logout()">로그아웃</button>
    </div>
</div>

<header><h1>질문 게시판</h1></header>

<nav>
    <a href="introduce.html">동아리 소개</a>
    <a href="question.html">질문 게시판</a>
    <a href="activity.html">활동 사진</a>
    <a href="resource.html">자료실</a>
    <a href="weather.html">기상 정보</a>
</nav>

<div class="container">
    <div class="search-box">
        <input type="text" id="qSearch" onkeyup="filterQuestions()" placeholder="질문 내용을 검색하세요...">
    </div>

    <div class="write-card">
        <input type="text" id="qInput" placeholder="질문 내용을 입력하세요. (비로그인은 익명 등록)">
        <button class="btn-main" onclick="addQuestion()">질문 등록</button>
    </div>

    <div id="questionList">
        <p style="text-align:center;">데이터를 불러오는 중입니다...</p>
    </div>
</div>

<footer>© DEEP SKY | Bokseong Astronomy and Aerospace Club | All rights reserved.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase 설정
const firebaseConfig = {
    apiKey: "AIzaSyBX9JG1Ngnx_Pt02ROG2Hp69rnNbK0Pjp8",
    authDomain: "clubquestion.firebaseapp.com",
    databaseURL: "https://clubquestion-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "clubquestion",
    storageBucket: "clubquestion.firebasestorage.app",
    messagingSenderId: "730586449237",
    appId: "1:730586449237:web:81b733cf9fc3a5b67fdbdc"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_EMAIL = "2jw5464@gmail.com";

let currentUser = null;

auth.onAuthStateChanged(user => {
    currentUser = user;
    const status = document.getElementById("userStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (user) {
        status.innerText = `${user.displayName || user.email.split('@')[0]}님`;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
    } else {
        status.innerText = "로그인 해주세요";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
    }
    loadQuestions();
});

// 질문 등록 함수 (수정됨)
function addQuestion() {
    const text = document.getElementById("qInput").value.trim();
    if(!text) return alert("질문을 입력해주세요.");

    const newQuestion = {
        text: text,
        // 로그인 상태면 닉네임, 아니면 '익명'
        author: currentUser ? (currentUser.displayName || currentUser.email.split('@')[0]) : "익명",
        // 로그인 상태면 이메일, 아니면 'anonymous' (규칙에서 삭제 권한 확인용)
        email: currentUser ? currentUser.email : "anonymous",
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    db.ref("questions").push(newQuestion)
        .then(() => {
            alert("질문이 등록되었습니다.");
            document.getElementById("qInput").value = "";
        })
        .catch(err => alert("등록 실패: " + err.message));
}

function loadQuestions() {
    db.ref("questions").on("value", snapshot => {
        const list = document.getElementById("questionList");
        list.innerHTML = "";
        const data = snapshot.val();
        
        if(!data) {
            list.innerHTML = "<p style='text-align:center;'>첫 질문을 기다리고 있습니다.</p>";
            return;
        }

        Object.keys(data).reverse().forEach(key => {
            const q = data[key];
            const isAuthor = currentUser && currentUser.email === q.email;
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            
            const card = document.createElement("div");
            card.className = "q-card";
            
            let answerHtml = q.answer ? `<div class="ans-box"><b>A.</b> ${q.answer}</div>` : "";
            let controlsHtml = "";

            if (currentUser) {
                controlsHtml = `<div class="answer-controls">
                    <input type="text" id="ans_${key}" placeholder="답변을 입력하세요">
                    <button class="btn-ans" onclick="saveAnswer('${key}')">답변등록</button>`;
                if (isAuthor || isAdmin) {
                    controlsHtml += `<button class="btn-del" onclick="deleteQuestion('${key}')">삭제</button>`;
                }
                controlsHtml += `</div>`;
            }

            card.innerHTML = `
                <div class="q-meta">${q.author} | ${new Date(q.createdAt).toLocaleDateString()}</div>
                <span class="q-text">Q. ${q.text}</span>
                ${answerHtml}
                ${controlsHtml}
            `;
            list.appendChild(card);
        });
    });
}

function filterQuestions() {
    const term = document.getElementById("qSearch").value.toLowerCase();
    const cards = document.getElementsByClassName("q-card");
    for (let card of cards) {
        card.style.display = card.innerText.toLowerCase().includes(term) ? "" : "none";
    }
}

function saveAnswer(key) {
    const ans = document.getElementById("ans_"+key).value.trim();
    if(!ans) return alert("답변을 입력하세요.");
    db.ref("questions/"+key).update({ answer: ans })
        .then(() => alert("답변이 등록되었습니다."));
}

function deleteQuestion(key) {
    if(confirm("정말 삭제할까요?")) db.ref("questions/"+key).remove();
}

function logout() { if(confirm("로그아웃 하시겠습니까?")) auth.signOut(); }
</script>
</body>
</html>
