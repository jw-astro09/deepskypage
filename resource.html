<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자료실 - DEEP SKY</title>
    <style>
        /* 1. 공통 스타일 */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: #0b0f2b; color: white; }

        /* 2. 상단 바 (로고 18px, 높이 60px) */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: #070a1d; border-bottom: 1px solid #1b2f80;
            height: 60px; position: sticky; top: 0; z-index: 1000;
        }
        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; }

        .auth-bar { font-size: 14px; display: flex; align-items: center; }
        .auth-bar button {
            padding: 5px 12px; margin-left: 10px; border-radius: 5px; border: none;
            background: #3a5aff; color: white; cursor: pointer; font-weight: bold;
        }

        /* 3. 헤더 및 내비게이션 */
        header { background: linear-gradient(to right, #0d1b52, #1b2f80); padding: 40px 20px; text-align: center; }
        nav { background: #11153a; padding: 0 10px; text-align: center; border-bottom: 1px solid #2d367a; overflow-x: auto; white-space: nowrap; }
        nav a { display: inline-block; color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; font-size: 15px; }

        /* 4. 본문 및 테이블 */
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px 100px; }
        
        .search-box { margin-bottom: 20px; }
        .search-box input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80;
            background: #161b4a; color: white; font-size: 15px;
        }

        table { width: 100%; border-collapse: collapse; background: #161b4a; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #2d367a; }
        th { background: #1b2f80; color: #7fc7ff; font-size: 14px; }
        
        .download-link { color: #7fc7ff; text-decoration: none; font-weight: bold; }
        .download-link:hover { text-decoration: underline; }
        
        .delete-btn { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 12px; }

        .hidden { display: none !important; }
        footer { background: #070a1d; text-align: center; padding: 20px; font-size: 12px; color: #888; border-top: 1px solid #1b2f80; position: fixed; bottom: 0; width: 100%; }

        @media (max-width: 600px) {
            .logo-area span { font-size: 16px; }
            th, td { padding: 10px; font-size: 13px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/35'">
        <span>DEEP SKY</span>
    </a>
    <div class="auth-bar">
        <span id="userStatus">확인 중...</span>
        <button id="loginBtn" onclick="location.href='login.html'">로그인</button>
        <button id="logoutBtn" class="hidden" onclick="logout()">로그아웃</button>
    </div>
</div>

<header><h1>자료실</h1></header>

<nav>
    <a href="introduce.html">동아리 소개</a>
    <a href="question.html">질문 게시판</a>
    <a href="activity.html">활동 사진</a>
    <a href="resource.html">자료실</a>
</nav>

<div class="container" id="mainContent">
    <div class="search-box">
        <input type="text" id="resSearch" onkeyup="filterResources()" placeholder="자료 제목 검색...">
    </div>

    <table>
        <thead>
            <tr>
                <th>제목</th>
                <th>작성자</th>
                <th>링크</th>
            </tr>
        </thead>
        <tbody id="resTableBody">
            </tbody>
    </table>
</div>

<footer>© DEEP SKY | All rights reserved.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBX9JG1Ngnx_Pt02ROG2Hp69rnNbK0Pjp8",
    authDomain: "clubquestion.firebaseapp.com",
    databaseURL: "https://clubquestion-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "clubquestion",
    storageBucket: "clubquestion.firebasestorage.app",
    messagingSenderId: "730586449237",
    appId: "1:730586449237:web:81b733cf9fc3a5b67fdbdc"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_EMAIL = "2jw5464@gmail.com";

// ★ 로그인 체크 로직 ★
auth.onAuthStateChanged(user => {
    const status = document.getElementById("userStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (user) {
        status.innerText = `${user.displayName || user.email.split('@')[0]}님`;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        loadResources(); // 로그인 시 데이터 로드
    } else {
        // 비로그인 시 처리
        alert("자료실은 회원만 이용 가능합니다. 로그인을 해주세요!");
        location.href = "login.html"; // 로그인 페이지로 리다이렉트
    }
});

// 자료 목록 로드
function loadResources() {
    db.ref("resources").on("value", snapshot => {
        const tableBody = document.getElementById("resTableBody");
        tableBody.innerHTML = "";
        const data = snapshot.val();
        
        if (!data) {
            tableBody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>등록된 자료가 없습니다.</td></tr>";
            return;
        }

        Object.keys(data).reverse().forEach(key => {
            const res = data[key];
            const isAdmin = auth.currentUser?.email === ADMIN_EMAIL;
            const isOwner = auth.currentUser?.email === res.ownerEmail;
            
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${res.title}</td>
                <td style="color:#7fc7ff; font-size:12px;">${res.ownerName || "익명"}</td>
                <td>
                    <a href="${res.url}" target="_blank" class="download-link">다운로드/보기</a>
                    ${(isAdmin || isOwner) ? `<button class="delete-btn" onclick="deleteRes('${key}')">삭제</button>` : ""}
                </td>
            `;
            tableBody.appendChild(row);
        });
    });
}

function filterResources() {
    const term = document.getElementById("resSearch").value.toLowerCase();
    const rows = document.getElementById("resTableBody").getElementsByTagName("tr");
    for (let row of rows) {
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
    }
}

function deleteRes(key) {
    if(confirm("이 자료를 삭제하시겠습니까?")) {
        db.ref("resources/" + key).remove();
    }
}

function logout() {
    if(confirm("로그아웃 하시겠습니까?")) {
        auth.signOut().then(() => {
            alert("로그아웃 되었습니다.");
            location.href = "index.html";
        });
    }
}
</script>
</body>
</html>
